<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <title>Каталог запчастей</title>
</head>
<body>

<header class="header active">
  <div id="menu-btn" class="fas fa-bars"></div>
  <a href="index.html" class="logo"><span>авто</span>Партс</a>
  <nav class="navbar">
    <a href="index.html#home">домашняя</a>
    <a href="index.html#vehicles">автомобили</a>
    <a href="index.html#services">сервисы</a>
    <a href="index.html#featured">рекомендуемое</a>
    <a href="index.html#reviews">отзывы</a>
    <a href="index.html#contact">контакт</a>
  </nav>
  <div id="login-btn"><button class="btn">вход</button><i class="far fa-user"></i></div>
</header>

<section class="parts-repair">
  <h1 class="heading">Каталог <span>запчастей</span></h1>

  <!-- ФИЛЬТРЫ -->
  <div class="filters-container">
    <div class="filter-box">
      <h3>Категория</h3>
      <select id="category-select"><option value="all">Все категории</option></select>
    </div>
    <div class="filter-box">
      <h3>Бренд</h3>
      <select id="brand-select"><option value="all">Все бренды</option></select>
    </div>
    <div class="filter-box">
      <h3>Наличие</h3>
      <select id="stock-select">
        <option value="all">Все товары</option>
        <option value="in-stock">В наличии</option>
        <option value="low-stock">Мало на складе</option>
        <option value="out-of-stock">Нет в наличии</option>
      </select>
    </div>
    <div class="filter-box">
      <h3>Сортировка</h3>
      <select id="sort-select">
        <option value="default">По умолчанию</option>
        <option value="price-asc">Цена ↑</option>
        <option value="price-desc">Цена ↓</option>
        <option value="name-asc">Название А→Я</option>
        <option value="name-desc">Название Я→А</option>
      </select>
    </div>
    <button class="btn filter-btn" onclick="filterItems()">Применить</button>
  </div>

  <div class="catalog" id="parts-catalog"></div>
</section>

<script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>
<script>
const REFRESH_MS = 30_000;
let partsData = [];
let prevPrices = new Map();
let lastDigest = null;

// При загрузке страницы и далее - опрашиваем JSON
document.addEventListener('DOMContentLoaded', () => {
  loadAndRender();
  setInterval(loadAndRender, REFRESH_MS);
  document.addEventListener('visibilitychange', () => !document.hidden && loadAndRender());
});

function loadAndRender() {
  fetch('export_fixed.json?ts=' + Date.now(), { cache: 'no-store' })
    .then(res => res.json())
    .then(data => {
      // Заполним картинки и рейтинг, если не хватает
      data.forEach(part => {
        if (!part.img) part.img = `image/part-${(part.id % 6) + 1}.png`;
        if (!part.rating) part.rating = (Math.random() * 1 + 4).toFixed(1);
      });

      // Сравним цены с предыдущими
      const digest = JSON.stringify(data.map(p => [p.id, p.price, p.stock]));
      if (digest === lastDigest && partsData.length) return;
      lastDigest = digest;

      // Основные данные для каталога
      partsData = data;
      populateFilters();
      filterItems();

      // Сохраним новые цены для следующей проверки
      data.forEach(p => prevPrices.set(p.id, p.price));
    })
    .catch(err => {
      document.getElementById('parts-catalog').innerHTML = '<div class="no-results"><i class="fas fa-exclamation-triangle"></i><h3>Ошибка загрузки данных</h3></div>';
      console.error('Ошибка загрузки JSON:', err);
    });
}

// Фильтры (категория, бренд)
function populateFilters() {
  const categorySelect = document.getElementById('category-select');
  const brandSelect = document.getElementById('brand-select');
  // Сбросить текущие опции
  categorySelect.innerHTML = '<option value="all">Все категории</option>';
  brandSelect.innerHTML = '<option value="all">Все бренды</option>';
  // Добавить уникальные значения
  [...new Set(partsData.map(p => p.category))].forEach(cat => {
    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
  [...new Set(partsData.map(p => p.brand))].forEach(br => {
    brandSelect.innerHTML += `<option value="${br}">${br}</option>`;
  });
}

function filterItems() {
  const cat  = document.getElementById('category-select').value;
  const br   = document.getElementById('brand-select').value;
  const stk  = document.getElementById('stock-select').value;
  const sort = document.getElementById('sort-select').value;

  let items = partsData.slice();
  if (cat !== 'all') items = items.filter(p => p.category === cat);
  if (br  !== 'all') items = items.filter(p => p.brand    === br);

  if (stk === 'in-stock')          items = items.filter(p => p.stock > 10);
  else if (stk === 'low-stock')    items = items.filter(p => p.stock > 0 && p.stock <= 10);
  else if (stk === 'out-of-stock') items = items.filter(p => p.stock === 0);

  if (sort !== 'default') {
    const cmp = {
      'price-asc':  (a, b) => a.price - b.price,
      'price-desc': (a, b) => b.price - a.price,
      'name-asc':   (a, b) => a.name.localeCompare(b.name),
      'name-desc':  (a, b) => b.name.localeCompare(a.name),
    }[sort];
    items.sort(cmp);
  }
  renderParts(items);
}

// Сама отрисовка карточек + подсветка цены
function renderParts(arr) {
  const box = document.getElementById('parts-catalog');
  if (!arr.length) {
    box.innerHTML = '<div class="no-results"><i class="fas fa-search"></i><h3>Ничего не найдено</h3></div>';
    return;
  }
  box.innerHTML = arr.map(p => {
    // --- статус/бейдж ---
    let badge = '', stockTxt = '', stockClass = '';
    if (p.stock > 10)      { stockTxt = 'В наличии';        badge = '<span class="badge new">NEW</span>'; stockClass = 'in-stock'; }
    else if (p.stock > 0)  { stockTxt = `Мало (${p.stock})`; badge = '<span class="badge sale">SALE</span>'; stockClass = 'low-stock'; }
    else                   { stockTxt = 'Нет в наличии';    badge = '<span class="badge out">OUT</span>';  stockClass = 'out-of-stock'; }

    // --- рейтинг ---
    const full = Math.floor(p.rating), half = p.rating % 1 >= 0.5;
    let stars = '';
    for (let i = 1; i <= 5; i++)
      stars += i <= full ? '<i class="fas fa-star"></i>' :
        i === full + 1 && half ? '<i class="fas fa-star-half-alt"></i>' : '<i class="far fa-star"></i>';

    // --- проверка цены ---
    let priceClass = '';
    const oldPrice = prevPrices.get(p.id);
    if (oldPrice !== undefined && oldPrice !== p.price) {
      priceClass = p.price > oldPrice ? 'price-up' : 'price-down';
    }

    return `
      <div class="item" data-id="${p.id}">
        ${badge}
        <div class="brand-logo">${p.brand}</div>
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <div class="category" data-category="${p.category}">${p.category}</div>
        <div class="price ${priceClass}">${p.price.toLocaleString('ru-RU')} ₽</div>
        <p>${p.description || ''}</p>
        <div class="stock ${stockClass}">${stockTxt}</div>
        <div class="rating">${stars} <span>${p.rating}</span></div>
      </div>
    `;
  }).join('');

  // Удаляем классы подсветки после анимации
  arr.forEach(p => {
    if (!prevPrices.has(p.id)) return;
    const item = document.querySelector(`.item[data-id="${p.id}"] .price`);
    if (item) {
      setTimeout(() => item.classList.remove('price-up', 'price-down'), 1600);
    }
  });
}
</script>




<script src="script.js"></script>
</body>
</html>
