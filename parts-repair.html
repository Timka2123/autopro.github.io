<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <title>Каталог запчастей</title>
</head>
<body>

<header class="header active">
  <div id="menu-btn" class="fas fa-bars"></div>
  <a href="index.html" class="logo"><span>авто</span>Партс</a>
  <nav class="navbar">
    <a href="index.html#home">домашняя</a>
    <a href="index.html#vehicles">автомобили</a>
    <a href="index.html#services">сервисы</a>
    <a href="index.html#featured">рекомендуемое</a>
    <a href="index.html#reviews">отзывы</a>
    <a href="index.html#contact">контакт</a>
  </nav>
  <div id="login-btn"><button class="btn">вход</button><i class="far fa-user"></i></div>
</header>

<section class="parts-repair">
  <h1 class="heading">Каталог <span>запчастей</span></h1>

  <!-- ФИЛЬТРЫ -->
  <div class="filters-container">
    <div class="filter-box">
      <h3>Категория</h3>
      <select id="category-select"><option value="all">Все категории</option></select>
    </div>
    <div class="filter-box">
      <h3>Бренд</h3>
      <select id="brand-select"><option value="all">Все бренды</option></select>
    </div>
    <div class="filter-box">
      <h3>Наличие</h3>
      <select id="stock-select">
        <option value="all">Все товары</option>
        <option value="in-stock">В наличии</option>
        <option value="low-stock">Мало на складе</option>
        <option value="out-of-stock">Нет в наличии</option>
      </select>
    </div>
    <div class="filter-box">
      <h3>Сортировка</h3>
      <select id="sort-select">
        <option value="default">По умолчанию</option>
        <option value="price-asc">Цена ↑</option>
        <option value="price-desc">Цена ↓</option>
        <option value="name-asc">Название А→Я</option>
        <option value="name-desc">Название Я→А</option>
      </select>
    </div>
    <button class="btn filter-btn" onclick="filterItems()">Применить</button>
  </div>

  <div class="catalog" id="parts-catalog"></div>
</section>

<script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>
<script>
/* ====== НАСТРОЙКИ ====== */
const REFRESH_MS = 30_000;          // 30 секунд

/* ====== ГЛОБАЛЬНЫЕ ДАННЫЕ ====== */
let partsData    = [];
let lastDigest   = null;

/* ====== ПЕРВЫЙ ЗАПУСК И ТАЙМЕР ====== */
document.addEventListener('DOMContentLoaded', () => {
  loadJsonAndRender();
  setInterval(loadJsonAndRender, REFRESH_MS);
  document.addEventListener('visibilitychange', () => !document.hidden && loadJsonAndRender());
});

/* ====== ЗАГРУЗКА И ПЕРЕРИСОВКА ====== */
async function loadJsonAndRender(){
  try{
    const res  = await fetch(`export_fixed.json?ts=${Date.now()}`,{cache:'no-store'});
    const data = await res.json();

    const digest = JSON.stringify(data.map(p=>[p.id,p.price,p.stock]));
    if (digest === lastDigest) return;               // файл не менялся
    lastDigest = digest;

    partsData = data.map(p=>({
      ...p,
      rating: p.rating ?? (Math.random()*1+4).toFixed(1),
      img:    p.img    ?? `image/part-${Math.floor(Math.random()*6)+1}.png`
    }));

    populateFilters();
    filterItems();
    console.log('[catalog] updated',new Date().toLocaleTimeString());
  }catch(e){console.error('JSON load error',e);}
}

/* ====== ФИЛЬТРЫ ====== */
function populateFilters(){
  const cats   = ['all',...new Set(partsData.map(p=>p.category))];
  const brands = ['all',...new Set(partsData.map(p=>p.brand))];

  const catSel = document.getElementById('category-select');
  const brSel  = document.getElementById('brand-select');

  catSel.innerHTML = cats.map(v=>`<option value="${v}">${v==='all'?'Все категории':v}</option>`).join('');
  brSel.innerHTML  = brands.map(v=>`<option value="${v}">${v==='all'?'Все бренды':v}</option>`).join('');
}

function filterItems(){
  const cat  = category-select.value;
  const br   = brand-select.value;
  const stk  = stock-select.value;
  const sort = sort-select.value;

  let items = partsData.slice();

  if (cat!=='all') items = items.filter(p=>p.category===cat);
  if (br!=='all')  items = items.filter(p=>p.brand===br);

  if (stk==='in-stock')      items = items.filter(p=>p.stock>10);
  else if (stk==='low-stock')items = items.filter(p=>p.stock>0&&p.stock<=10);
  else if (stk==='out-of-stock') items = items.filter(p=>p.stock===0);

  if (sort!=='default'){
    const fn = {
      'price-asc':  (a,b)=>a.price-b.price,
      'price-desc': (a,b)=>b.price-a.price,
      'name-asc':   (a,b)=>a.name.localeCompare(b.name),
      'name-desc':  (a,b)=>b.name.localeCompare(a.name)
    }[sort];
    items.sort(fn);
  }
  renderParts(items);
}

/* ====== РЕНДЕР КАРТОЧЕК ====== */
function renderParts(arr){
  const box = document.getElementById('parts-catalog');
  if (!arr.length){
    box.innerHTML =
      '<div class="no-results"><i class="fas fa-search"></i><h3>Ничего не найдено</h3></div>';
    return;
  }
  box.innerHTML = arr.map(p=>{
    /* бейдж + статус */
    let badge   = '', stockTxt = '';
    if (p.stock>10){ stockTxt='В наличии';           badge='<span class="badge new">NEW</span>'; }
    else if (p.stock>0){ stockTxt=`Мало (${p.stock})`;badge='<span class="badge sale">SALE</span>'; }
    else { stockTxt='Нет в наличии';                 badge='<span class="badge out">OUT</span>'; }

    /* звёздочки */
    const full = Math.floor(p.rating), half = p.rating%1>=0.5;
    let stars = '';
    for(let i=1;i<=5;i++)
      stars += i<=full ? '<i class="fas fa-star"></i>' :
               i===full+1 && half ? '<i class="fas fa-star-half-alt"></i>' :
               '<i class="far fa-star"></i>';

    return `
      <div class="item">
        ${badge}
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p class="price">${p.price.toLocaleString()} ₽</p>
        <p class="category">${p.category}</p>
        <p class="stock">${stockTxt}</p>
        <div class="rating">${stars}</div>
      </div>`;
  }).join('');
}
</script>

<script src="script.js"></script>
</body>
</html>
