<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Стили -->
  <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  
  <title>Каталог запчастей</title>
</head>
<body>

  <!-- Шапка -->
  <header class="header active">
    <div id="menu-btn" class="fas fa-bars"></div>
    <a href="index.html" class="logo"> <span>авто</span>Партс </a>
    <nav class="navbar">
      <a href="index.html#home">домашняя</a>
      <a href="index.html#vehicles">автомобили</a>
      <a href="index.html#services">сервисы</a>
      <a href="index.html#featured">рекомендуемое</a>
      <a href="index.html#reviews">отзывы</a>
      <a href="index.html#contact">контакт</a>
    </nav>
    <div id="login-btn">
      <button class="btn">вход</button>
      <i class="far fa-user"></i>
    </div>
  </header>

  <!-- Контент -->
  <section class="parts-repair">
    <h1 class="heading">Каталог <span>запчастей</span></h1>

    <div class="filters-container">
      <div class="filter-box">
        <h3>Категория</h3>
        <select id="category-select">
          <option value="all">Все категории</option>
        </select>
      </div>
      <div class="filter-box">
        <h3>Бренд</h3>
        <select id="brand-select">
          <option value="all">Все бренды</option>
        </select>
      </div>
      <div class="filter-box">
        <h3>Наличие</h3>
        <select id="stock-select">
          <option value="all">Все товары</option>
          <option value="in-stock">В наличии</option>
          <option value="low-stock">Мало на складе</option>
          <option value="out-of-stock">Нет в наличии</option>
        </select>
      </div>
      <div class="filter-box">
        <h3>Сортировка</h3>
        <select id="sort-select">
          <option value="default">По умолчанию</option>
          <option value="price-asc">Цена: по возрастанию</option>
          <option value="price-desc">Цена: по убыванию</option>
          <option value="name-asc">Название: А→Я</option>
          <option value="name-desc">Название: Я→А</option>
        </select>
      </div>
      <button class="btn filter-btn" onclick="filterItems()">Применить</button>
    </div>

    <div class="catalog" id="parts-catalog">
      <!-- Карточки запчастей будут вставляться сюда -->
    </div>
  </section>

  <!-- Скрипты: сначала Swiper для слайдеров, потом наш основной код -->
  <script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>
  <script>
    // ====== НАСТРОЙКИ ======
    const REFRESH_MS = 5 * 60_000;  // 5 минут

    // ====== ГЛОБАЛЫ ======
    let partsData    = [];          // текущий массив запчастей
    let lastDataHash = null;        // строковое сравнение, чтобы не рисовать без надобности

    // ====== ПЕРВЫЙ ЗАПУСК И ТАЙМЕР ======
    document.addEventListener('DOMContentLoaded', () => {
      loadJsonAndRender();
      setInterval(loadJsonAndRender, REFRESH_MS);
    });

    // ====== ЗАГРУЗКА JSON + РЕНДЕР ======
    async function loadJsonAndRender() {
      try {
        const resp = await fetch(`export_fixed.json?ts=${Date.now()}`);
        const data = await resp.json();

        const hash = JSON.stringify(data);
        if (hash === lastDataHash) return;
        lastDataHash = hash;

        partsData = data.map(d => ({
          ...d,
          // если некоторых полей нет, можете дефолтно их заполнить:
          rating:   d.rating ?? (Math.random()*1+4).toFixed(1),
          img:      d.img    ?? `image/part-${Math.floor(Math.random()*6)+1}.png`
        }));

        populateFilters();
        filterItems();
        console.log('catalog updated at', new Date().toLocaleTimeString());
      } catch(err) {
        console.error('Не удалось загрузить export_fixed.json:', err);
      }
    }

    // ====== ЗАПОЛНЕНИЕ ВЫПАДАЮЩИХ СПИСКОВ ======
    function populateFilters() {
      const cats   = ['all', ...new Set(partsData.map(p=>p.category))];
      const brands = ['all', ...new Set(partsData.map(p=>p.brand))];

      const catSel   = document.getElementById('category-select');
      const brandSel = document.getElementById('brand-select');
      catSel.innerHTML   = cats.map(v => `<option value="${v}">${v==='all'? 'Все категории' : v}</option>`).join('');
      brandSel.innerHTML = brands.map(v=> `<option value="${v}">${v==='all'? 'Все бренды' : v}</option>`).join('');
    }

    // ====== ФИЛЬТРАЦИЯ И СОРТИРОВКА ======
    function filterItems() {
      const cat   = document.getElementById('category-select').value;
      const br    = document.getElementById('brand-select').value;
      const stk   = document.getElementById('stock-select').value;
      const sort  = document.getElementById('sort-select').value;

      let filtered = partsData.slice();
      if (cat   !== 'all') filtered = filtered.filter(p=>p.category===cat);
      if (br    !== 'all') filtered = filtered.filter(p=>p.brand===br);
      if (stk   === 'in-stock')    filtered = filtered.filter(p=>p.stock>10);
      if (stk   === 'low-stock')   filtered = filtered.filter(p=>p.stock>0&&p.stock<=10);
      if (stk   === 'out-of-stock')filtered = filtered.filter(p=>p.stock===0);

      if (sort !== 'default') {
        filtered.sort((a,b)=>{
          switch(sort){
            case 'price-asc':  return a.price - b.price;
            case 'price-desc': return b.price - a.price;
            case 'name-asc':   return a.name.localeCompare(b.name);
            case 'name-desc':  return b.name.localeCompare(a.name);
          }
        });
      }
      renderParts(filtered);
    }

    // ====== ОТОБРАЖЕНИЕ КАРТОЧЕК ======
    function renderParts(items) {
      const container = document.getElementById('parts-catalog');
      container.innerHTML = '';

      if (items.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <i class="fas fa-search"></i>
            <h3>Ничего не найдено</h3>
            <p>Попробуйте другие параметры фильтрации.</p>
          </div>`;
        return;
      }

      items.forEach(p => {
        // статус и бейдж
        let stockText = '', badge = '';
        if (p.stock > 10) {
          stockText = 'В наличии'; badge = '<span class="badge new">NEW</span>';
        } else if (p.stock > 0) {
          stockText = `Мало (${p.stock})`; badge = '<span class="badge sale">SALE</span>';
        } else {
          stockText = 'Нет в наличии'; badge = '<span class="badge out">OUT</span>';
        }

        // рейтинг
        const fullStars = Math.floor(p.rating),
              halfStar  = p.rating % 1 >= 0.5;
        let stars = '';
        for (let i=1; i<=5; i++){
          if      (i<=fullStars)                stars += '<i class="fas fa-star"></i>';
          else if (i===fullStars+1 && halfStar) stars += '<i class="fas fa-star-half-alt"></i>';
          else                                  stars += '<i class="far fa-star"></i>';
        }

        container.insertAdjacentHTML('beforeend', `
          <div class="item">
            ${badge}
            <img src="${p.img}" alt="${p.name}">
            <h3>${p.name}</h3>
            <p class="price">${p.price.toLocaleString()} ₽</p>
            <p class="category">${p.category}</p>
            <p class="stock">${stockText}</p>
            <div class="rating">${stars}</div>
          </div>`);
      });
    }
  </script>
</body>
</html>
