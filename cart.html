<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–æ—Ä–∑–∏–Ω–∞ | Autopro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { background: #212324; color: #fff; font-family: Arial, sans-serif; }
    .container { max-width: 600px; margin: 50px auto; background: #26282a; border-radius: 18px; box-shadow: 0 8px 40px #0006; padding: 2em 2.5em; }
    h1 { font-size: 2.2em; margin-bottom: .7em; text-align: center; }
    .cart-list { margin-bottom: 2em; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #3336; padding: .8em 0; gap: 10px;}
    .cart-item:last-child { border-bottom: none; }
    .cart-item span { font-size: 1.1em; }
    .cart-remove { color: #f44336; background: none; border: none; cursor: pointer; font-size: 1.2em; margin-left: 10px; }
    #cart-total { font-size: 1.25em; text-align: right; margin-bottom: 1.2em; }
    .empty-cart { text-align: center; color: #bbb; margin: 2em 0; font-size: 1.2em; }
    #order-btn { width: 100%; background: linear-gradient(90deg,#ffc107,#f44336); color: #232323; font-weight: bold; border: none; border-radius: 10px; font-size: 1.25em; padding: 0.9em; cursor: pointer; transition: .2s; box-shadow: 0 3px 10px #f4433644;}
    #order-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    @media (max-width: 600px) {
      .container { padding: 1em .5em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-shopping-cart"></i> –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <div class="cart-list" id="cart-items-list"></div>
    <div id="cart-total"></div>
    <button id="order-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <div id="order-status" style="margin-top:1.2em; text-align:center;"></div>
  </div>

  <!-- Firebase, EmailJS –∏ —Ç–≤–æ–∏ —Å–∫—Ä–∏–ø—Ç—ã -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // Firebase config –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const firebaseConfig = {
      apiKey: "AIzaSyAjVd0NGBE3_r4Ot9phZ-SzIhWMyEYNfrw",
      authDomain: "autopro-e3161.firebaseapp.com",
      projectId: "autopro-e3161",
      storageBucket: "autopro-e3161.appspot.com",
      messagingSenderId: "274244574652",
      appId: "1:274244574652:web:012f0b403667f98b5c1fb9",
      measurementId: "G-G0FH4XQTCC"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmailJS Public Key (–∞ –Ω–µ service!)
    emailjs.init('Q78mxFzz_Dx_tyVpO');

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
    let partsData = [];
    fetch('export_fixed.json').then(r => r.json()).then(d => { partsData = d; renderCartItems(); });

    // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã
    function getCartData() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      return cart.map(id => partsData.find(p => p.id == id)).filter(Boolean);
    }

    function removeFromCart(id) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart = cart.filter(cid => cid != id);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCartItems();
      updateCartCounter?.();
    }

    function renderCartItems() {
      const cartItems = getCartData();
      const list = document.getElementById('cart-items-list');
      const total = document.getElementById('cart-total');
      const orderBtn = document.getElementById('order-btn');
      if (!cartItems.length) {
        list.innerHTML = '<div class="empty-cart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ <br><a href="index.html" style="color:#f9d806;text-decoration:underline;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∫—É–ø–∫–∞–º</a></div>';
        total.innerHTML = '';
        orderBtn.disabled = true;
        return;
      }
      list.innerHTML = cartItems.map(p => `
        <div class="cart-item">
          <span>${p.name} <span style="color:#999;font-size:.9em;">(–∞—Ä—Ç. ${p.id})</span></span>
          <span><b>${p.price}</b> ‚ÇΩ 
            <button class="cart-remove" title="–£–¥–∞–ª–∏—Ç—å" onclick="removeFromCart('${p.id}')"><i class="fas fa-trash"></i></button>
          </span>
        </div>
      `).join('');
      total.innerHTML = `<b>–ò—Ç–æ–≥–æ: ${cartItems.reduce((s, p) => s + p.price, 0)} ‚ÇΩ</b>`;
      orderBtn.disabled = false;
    }

    // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –≤ header (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
    function updateCartCounter() {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      let el = document.getElementById('cart-counter');
      if (el) el.textContent = cart.length;
    }

    // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    document.getElementById('order-btn').onclick = async function() {
      const user = firebase.auth().currentUser;
      if (!user) { alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞!'); return; }
      const cartItems = getCartData();
      if (!cartItems.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
      document.getElementById('order-status').innerHTML = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...";
      try {
        await sendOrderEmail(cartItems, user.email);
        await sendOrderTelegram(cartItems, user.email);
        document.getElementById('order-status').innerHTML = "–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –°–ø–∞—Å–∏–±–æ üòä";
        localStorage.removeItem('cart');
        renderCartItems();
        updateCartCounter();
      } catch(e) {
        document.getElementById('order-status').innerHTML = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞!";
      }
    };

    // --- EmailJS ---
    function sendOrderEmail(cartItems, userEmail) {
      const orderList = cartItems.map(p => `<li>${p.name} (${p.id}) ‚Äî ${p.price} ‚ÇΩ</li>`).join('');
      const templateParams = {
        user_email: userEmail,
        order_html: `<ul>${orderList}</ul>`,
        order_total: cartItems.reduce((s, p) => s + p.price, 0)
      };
      return emailjs.send('service_xxkj39b', 'template_qxz0943', templateParams);
    }
    // --- Telegram ---
    function sendOrderTelegram(cartItems, userEmail) {
      const TOKEN = '8153668086:AAHgyGjLfbkA2xQk4_Oyk6cwwbltXqXsLUg';
      const CHAT_ID = '2114460264';
      let msg = `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!\nEmail: ${userEmail}\n–¢–æ–≤–∞—Ä—ã:\n`;
      msg += cartItems.map(p => `${p.name} ‚Äî ${p.price} ‚ÇΩ`).join('\n');
      msg += `\n–í—Å–µ–≥–æ: ${cartItems.reduce((s, p) => s + p.price, 0)} ‚ÇΩ`;
      const url = `https://api.telegram.org/bot${TOKEN}/sendMessage`;
      return fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
      });
    }
  </script>
</body>
</html>
