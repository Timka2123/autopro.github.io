<!-- ... head –∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  // Firebase config –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  const firebaseConfig = {
    apiKey: "AIzaSyAjVd0NGBE3_r4Ot9phZ-SzIhWMyEYNfrw",
    authDomain: "autopro-e3161.firebaseapp.com",
    projectId: "autopro-e3161",
    storageBucket: "autopro-e3161.appspot.com",
    messagingSenderId: "274244574652",
    appId: "1:274244574652:web:012f0b403667f98b5c1fb9",
    measurementId: "G-G0FH4XQTCC"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmailJS Public Key (–∞ –Ω–µ service!)
  emailjs.init('Q78mxFzz_Dx_tyVpO');

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
  let partsData = [];
  fetch('export_fixed.json').then(r => r.json()).then(d => { partsData = d; renderCartItems(); });

  function getCartData() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    return cart.map(id => partsData.find(p => p.id == id)).filter(Boolean);
  }
  function removeFromCart(id) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart = cart.filter(cid => cid != id);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCartItems();
    updateCartCounter?.();
  }
  function renderCartItems() {
    const cartItems = getCartData();
    const list = document.getElementById('cart-items-list');
    const total = document.getElementById('cart-total');
    const orderBtn = document.getElementById('order-btn');
    if (!cartItems.length) {
      list.innerHTML = '<div class="empty-cart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ <br><a href="index.html" style="color:#f9d806;text-decoration:underline;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∫—É–ø–∫–∞–º</a></div>';
      total.innerHTML = '';
      orderBtn.disabled = true;
      return;
    }
    list.innerHTML = cartItems.map(p => `
      <div class="cart-item">
        <span>${p.name} <span style="color:#999;font-size:.9em;">(–∞—Ä—Ç. ${p.id})</span></span>
        <span><b>${p.price}</b> ‚ÇΩ 
          <button class="cart-remove" title="–£–¥–∞–ª–∏—Ç—å" onclick="removeFromCart('${p.id}')"><i class="fas fa-trash"></i></button>
        </span>
      </div>
    `).join('');
    total.innerHTML = `<b>–ò—Ç–æ–≥–æ: ${cartItems.reduce((s, p) => s + p.price, 0)} ‚ÇΩ</b>`;
    orderBtn.disabled = false;
  }
  function updateCartCounter() {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let el = document.getElementById('cart-counter');
    if (el) el.textContent = cart.length;
  }

  // --- –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —à–∞–±–ª–æ–Ω–∞ EmailJS ---
  function buildEmailParams(cartItems, userEmail) {
    const orderId = Date.now(); // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π id
    const orders = cartItems.map(p => ({
      image_url: p.img || '',
      name: p.name,
      units: 1, // –µ—Å–ª–∏ –±—É–¥–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî –≤—Å—Ç–∞–≤—å —Ä–µ–∞–ª—å–Ω–æ–µ
      price: p.price
    }));
    const total = cartItems.reduce((sum, p) => sum + p.price, 0);
    return {
      order_id: orderId,
      email: userEmail,
      orders: orders,
      cost: {
        shipping: 0,
        tax: 0,
        total: total
      }
    };
  }
  function sendOrderEmail(cartItems, userEmail) {
    const params = buildEmailParams(cartItems, userEmail);
    return emailjs.send('service_xxkj39b', 'template_qxz0943', params);
  }
  function sendOrderTelegram(cartItems, userEmail) {
    const TOKEN = '8153668086:AAHgyGjLfbkA2xQk4_Oyk6cwwbltXqXsLUg';
    const CHAT_ID = '2114460264';
    let msg = `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑!\nEmail: ${userEmail}\n–¢–æ–≤–∞—Ä—ã:\n`;
    msg += cartItems.map(p => `${p.name} ‚Äî ${p.price} ‚ÇΩ`).join('\n');
    msg += `\n–í—Å–µ–≥–æ: ${cartItems.reduce((s, p) => s + p.price, 0)} ‚ÇΩ`;
    const url = `https://api.telegram.org/bot${TOKEN}/sendMessage`;
    return fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
    });
  }

  document.getElementById('order-btn').onclick = async function() {
    const user = firebase.auth().currentUser;
    if (!user) { alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞!'); return; }
    const cartItems = getCartData();
    if (!cartItems.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
    document.getElementById('order-status').innerHTML = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...";
    try {
      await sendOrderEmail(cartItems, user.email);
      await sendOrderTelegram(cartItems, user.email);
      document.getElementById('order-status').innerHTML = "–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –°–ø–∞—Å–∏–±–æ üòä";
      localStorage.removeItem('cart');
      renderCartItems();
      updateCartCounter();
    } catch(e) {
      document.getElementById('order-status').innerHTML = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞!";
    }
  };
</script>
